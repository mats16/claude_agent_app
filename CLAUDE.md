# CLAUDE.md

Claude Code-like coding agent running on Databricks Apps. Turborepo monorepo with React + Fastify + Claude Agent SDK.

## Quick Start

```bash
cd app
npm install
npm run dev          # Frontend :5173, Backend :8000
npm run build        # Build all packages
npm run format       # Format code
npm run db:generate  # Generate migration from schema changes
```

## Architecture & Documentation

```
app/
â”œâ”€â”€ frontend/   # React + Vite + Ant Design v6 â†’ See @app/frontend/CLAUDE.md
â”œâ”€â”€ backend/    # Fastify + WebSocket + Claude Agent SDK â†’ See @app/backend/CLAUDE.md
â”‚   â”œâ”€â”€ agent/  # Claude Agent SDK config, MCP servers
â”‚   â”œâ”€â”€ db/     # Drizzle ORM (PostgreSQL)
â”‚   â”œâ”€â”€ models/ # Domain models (User, Session, etc.)
â”‚   â””â”€â”€ routes/ # REST API + WebSocket
â””â”€â”€ shared/     # Shared types (@app/shared) â†’ See @app/shared/CLAUDE.md
```

**ðŸ“š Module-specific documentation:**
- **[@app/backend/CLAUDE.md](app/backend/CLAUDE.md)** - Request context, RLS, auth, domain models, services
- **[@app/frontend/CLAUDE.md](app/frontend/CLAUDE.md)** - Context API, WebSocket hooks, theme system, i18n
- **[@app/shared/CLAUDE.md](app/shared/CLAUDE.md)** - TypeScript types for WebSocket/API communication

## Critical Patterns

### Auth: PAT-first + SP fallback
> **ðŸ“– See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#4-authentication-pat-first--sp-fallback) for auth details**

Uses user's PAT if available, otherwise falls back to Service Principal.
- `getAccessTokenForUser()` in `utils/auth.ts`
- Agent env vars configured in `agent/index.ts`

### PAT Encryption (AES-256-GCM)
> **ðŸ“– See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#4-authentication-pat-first--sp-fallback) for encryption details**

User PATs are encrypted at rest using AES-256-GCM via Drizzle CustomType.

**Setup:**
```bash
# Generate a 32-byte key (64 hex chars)
openssl rand -hex 32

# Set as environment variable or Databricks secret
export ENCRYPTION_KEY=<64-char-hex-string>
databricks secrets put-secret claude-agent encryption-key
```

**Error Handling Strategy:**

| Scenario | Behavior |
|----------|----------|
| `ENCRYPTION_KEY` not set | PAT feature disabled, warning logged at startup |
| Key format invalid | PAT feature disabled, error logged at startup |
| Key changed after PATs stored | Decryption fails gracefully, PAT treated as "not set" |
| Decryption failure | Warning logged, user prompted to re-configure PAT |

**Key Files:**
- `utils/encryption.ts` - AES-256-GCM encrypt/decrypt helpers
- `db/customTypes.ts` - `encryptedText` Drizzle CustomType
- `db/schema.ts` - `oauth_tokens.access_token` uses `encryptedText`
- `services/userService.ts` - `getUserPersonalAccessToken()` handles errors

### Session Model
> **ðŸ“– See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#2-domain-models-factory-pattern) for detailed patterns**

Uses TypeID-based identity with factory pattern.
```typescript
// Generate new session ID
const sessionId = SessionId.generate(); // â†’ session_01h455vb4pex5vsknk084sn02q

// Restore from DB
const session = Session.fromSelectSession(dbRecord);

// Access utilities
session.id.toString()      // â†’ "session_01h455vb4pex5vsknk084sn02q"
session.id.getSuffix()     // â†’ "01h455vb4pex5vsknk084sn02q"
session.getAppName()       // â†’ "app-01h455vb4pex5vsknk084sn02q"
session.getBranchName()    // â†’ "claude/session_01h455vb4pex5vsknk084sn02q"
session.cwd()              // â†’ "/path/to/sessions/01h455vb4pex5vsknk084sn02q"
```

**Key Files:** `backend/models/Session.ts`, `backend/db/sessions.ts`

### User Model
> **ðŸ“– See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#1-request-context-reqctx) for request context details**

Extracts user info from headers. Access paths via `user.local.*` / `user.remote.*`.
```typescript
const user = User.fromHeaders(request.headers);
// user.local.claudeConfigDir â†’ $HOME/users/{name}/.claude
// user.remote.claudeConfigDir â†’ /Workspace/Users/{email}/.claude
```

### DB: Row Level Security
> **ðŸ“– See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#3-row-level-security-rls) for detailed RLS patterns**

`sessions`, `settings`, `oauth_tokens` have RLS enabled. Always wrap queries:
```typescript
await withUserContext(db, userId, async () => { /* queries */ });
```

### Frontend State
> **ðŸ“– See [@app/frontend/CLAUDE.md](app/frontend/CLAUDE.md#context-first-data-fetching) for Context patterns**

Don't call same API from multiple components. Use Context:
- `UserContext` - User info + settings
- `SessionsContext` - Session list (client-side filtering)

### Workspace Sync
Auto-sync via Claude Code hooks (`settings.json`). Generated by ClaudeSettings model in `models/ClaudeSettings.ts`.
- SessionStart: Workspace â†’ Local (pull)
- Stop: Local â†’ Workspace (push, conditional)

## Naming Conventions

- DB/API: `snake_case` (`workspace_path`, `is_archived`)
- TypeScript: `camelCase` (`workspacePath`, `isArchived`)
- Session ID: TypeID with `session_` prefix (e.g., `session_01h455vb4pex5vsknk084sn02q`)
- App name: `app-{TypeID_suffix}` (30 chars, e.g., `app-01h455vb4pex5vsknk084sn02q`)

## Common Gotchas

**Backend-specific:** See [@app/backend/CLAUDE.md](app/backend/CLAUDE.md#common-gotchas) for 10 critical gotchas
**Frontend-specific:** See [@app/frontend/CLAUDE.md](app/frontend/CLAUDE.md#common-gotchas) for UI/state gotchas
**Shared types:** See [@app/shared/CLAUDE.md](app/shared/CLAUDE.md#common-gotchas) for type usage gotchas

**Top-level:**
1. **Drizzle v1.0+**: Use `drizzle({ client })` syntax (not `drizzle(client)`)
2. **MCP tool names**: Prefixed with `mcp__` in frontend
3. **Session interrupt**: Must save `result` event with `subtype: "interrupted"` (required for UI state)
4. **Migrations**: Auto-run on server startup

## UI/Design
> **ðŸ“– See [@app/frontend/CLAUDE.md](app/frontend/CLAUDE.md#theme-system) for theme system details**

- Brand: `#f5a623`
- Font: Noto Sans JP
- Icons: `@ant-design/icons`
- i18n: `react-i18next` (`en`, `ja`)
- **Always use `styles/theme.ts`** - Never hardcode colors/spacing

## Deployment

```bash
databricks bundle deploy -t dev   # Development
databricks bundle deploy -t prod  # Production
```

Secrets: `databricks secrets put-secret claude-agent database-url`
